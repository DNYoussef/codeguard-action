# Connascence Rubric
# Based on the 9 types of connascence (coupling)
# From weakest to strongest coupling
#
# Static Connascences: CoN, CoT, CoM, CoP, CoA
# Dynamic Connascences: CoE, CoT2, CoV, CoI

name: connascence
version: "1.0"
description: "Connascence coupling analysis - 9 types from weakest to strongest"

rules:
  # Static Connascences (Compile-time)

  - id: CON-001
    name: connascence_of_name
    category: coupling_static
    severity: low
    description: "Connascence of Name (CoN) - Components must agree on names"
    guidance: |
      CoN is the weakest form - acceptable when well-managed:
      - Use consistent naming conventions
      - Refactor renames across all usages
      - IDE support makes this manageable
    patterns:
      - "import\\s+[a-z_]+\\s+as\\s+[a-z_]+"
      - "import\\s+\\{[^}]+\\bas\\b[^}]+\\}\\s+from"

  - id: CON-002
    name: connascence_of_type
    category: coupling_static
    severity: low
    description: "Connascence of Type (CoT) - Components must agree on types"
    guidance: |
      CoT - manage with type hints:
      - Use explicit type annotations
      - Define shared type aliases
      - Consider Protocol classes for interfaces
    patterns:
      - "def\\s+[a-z][a-z_]+\\([^:)]*,\\s*[^:)]*,\\s*[^:)]+\\)\\s*:"
      - "function\\s+\\w+\\([^)]*,\\s*[^)]*,\\s*[^)]+\\)"
      - "\\w+\\s*:\\s*\\([^)]*,\\s*[^)]*,\\s*[^)]+\\)\\s*=>"
    exceptions:
      - "*_test.py"

  - id: CON-003
    name: connascence_of_meaning
    category: coupling_static
    severity: medium
    description: "Connascence of Meaning (CoM) - Components must agree on value meaning"
    guidance: |
      CoM is problematic - magic values:
      - Replace magic numbers with named constants
      - Use enums for categorical values
      - Document the meaning in one place
    patterns:
      - "==\\s*\\d{4,}"
      - "!=\\s*\\d{4,}"

  - id: CON-004
    name: connascence_of_position
    category: coupling_static
    severity: medium
    description: "Connascence of Position (CoP) - Order of elements matters"
    guidance: |
      CoP - positional arguments are fragile:
      - Use keyword arguments for functions with >3 params
      - Use dataclasses/namedtuples instead of tuples
      - Document expected order
    patterns:
      - "(?:function|def)\\s+\\w+\\([^)]*,\\s*[^)]*,\\s*[^)]*,\\s*[^)]*,\\s*[^)]*,\\s*[^)]*,\\s*[^)]*,\\s*[^)]*,\\s*[^)]*\\)"

  - id: CON-005
    name: connascence_of_algorithm
    category: coupling_static
    severity: medium
    description: "Connascence of Algorithm (CoA) - Components must agree on algorithm"
    guidance: |
      CoA - shared algorithm understanding:
      - Centralize algorithm implementations
      - Document algorithms thoroughly
      - Use well-known standards (SHA-256, etc.)
    patterns:
      - "(?:custom|ad.?hoc|home.?brew).*(?:hash|encrypt|encode)"
      - "(?:hash|encrypt|encode).*(?:custom|ad.?hoc|home.?brew)"
    exceptions:
      - "createHash\\("
      - "canonicalJson\\("
      - "sha256\\("
      - "computeContentHash\\("
      - "computeRootHash\\("

  # Dynamic Connascences (Runtime)

  - id: CON-006
    name: connascence_of_execution
    category: coupling_dynamic
    severity: high
    description: "Connascence of Execution (CoE) - Order of execution matters"
    guidance: |
      CoE is dangerous - order dependencies:
      - Make dependencies explicit
      - Use dependency injection
      - Consider state machines for complex flows
    patterns:
      - "must_be_called_first"
      - "after_init"
      - "before_save"
      - '\\.init\\(\\).*\\.start\\(\\)'

  - id: CON-007
    name: connascence_of_timing
    category: coupling_dynamic
    severity: high
    description: "Connascence of Timing (CoT2) - Timing of execution matters"
    guidance: |
      CoT2 - timing dependencies are fragile:
      - Avoid sleep() for synchronization
      - Use proper async/await patterns
      - Implement retry with backoff
    patterns:
      - "sleep\\(\\d+\\)"
      - "time\\.sleep"
      - "wait\\(\\d+\\)"

  - id: CON-008
    name: connascence_of_value
    category: coupling_dynamic
    severity: high
    description: "Connascence of Value (CoV) - Values must be synchronized"
    guidance: |
      CoV - shared mutable state:
      - Minimize shared state
      - Use immutable data structures
      - Implement proper synchronization
    patterns:
      - "global\\s+[a-z_]+"
      - "\\.shared_state"
      - "threading\\.Lock"
      - "(?:var|let)\\s+\\w+\\s*=.*\\bglobal"
      - "\\bwindow\\.\\w+\\s*="
      - "\\bglobalThis\\.\\w+\\s*="

  - id: CON-009
    name: connascence_of_identity
    category: coupling_dynamic
    severity: critical
    description: "Connascence of Identity (CoI) - Multiple components reference same entity"
    guidance: |
      CoI is the strongest coupling:
      - Avoid passing mutable objects across boundaries
      - Use value objects instead of entities where possible
      - Implement proper ownership semantics
    patterns:
      - "\\bid\\(\\w+\\)\\s*==\\s*id\\(\\w+\\)"
      - "===\\s*\\w+\\s*&&.*===\\s*\\w+"
