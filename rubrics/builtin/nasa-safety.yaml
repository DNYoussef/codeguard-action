# NASA Safety Rubric (Power of 10)
# Based on NASA/JPL's "The Power of 10: Rules for Developing Safety-Critical Code"
# Gerard J. Holzmann, NASA/JPL Laboratory for Reliable Software
#
# These rules are designed for safety-critical embedded systems
# but apply broadly to any high-reliability software.

name: nasa-safety
version: "1.0"
description: "NASA Power of 10 rules for safety-critical code development"

rules:
  - id: NASA-001
    name: simple_control_flow
    category: control_flow
    severity: high
    description: "Restrict all code to very simple control flow constructs"
    guidance: |
      Avoid goto, setjmp/longjmp, recursion:
      - No goto statements
      - No setjmp/longjmp
      - No direct or indirect recursion
      - Use simple loops with fixed bounds
    patterns:
      - "\\bgoto\\b"
      - "\\bsetjmp\\b"
      - "\\blongjmp\\b"

  - id: NASA-002
    name: fixed_loop_bounds
    category: loops
    severity: high
    description: "All loops must have a fixed upper bound"
    guidance: |
      Loops must be provably bounded:
      - Use for loops with explicit bounds
      - Avoid while(true) patterns
      - Document maximum iterations
      - Consider loop invariants
    patterns:
      - "while\\s*\\(\\s*True\\s*\\)"
      - "while\\s*\\(\\s*true\\s*\\)"
      - "while\\s*\\(\\s*1\\s*\\)"
      - "for\\s*\\(\\s*;\\s*;\\s*\\)"
      - "while\\s+True\\s*:"

  - id: NASA-003
    name: no_dynamic_allocation_after_init
    category: memory
    severity: high
    description: "Do not use dynamic memory allocation after initialization"
    guidance: |
      Allocate memory only during initialization:
      - Pre-allocate all needed memory
      - Use fixed-size buffers
      - Avoid malloc/free in operational code
      - Pool allocators acceptable if bounded
    patterns:
      - "\\bmalloc\\s*\\("
      - "\\bcalloc\\s*\\("
      - "\\brealloc\\s*\\("
      - "\\bfree\\s*\\("
    exceptions:
      - "*_init.py"
      - "*_setup.py"
      - "conftest.py"

  - id: NASA-004
    name: short_functions
    category: complexity
    severity: medium
    description: "No function should be longer than 60 lines of code"
    guidance: |
      Keep functions short and focused:
      - Maximum 60 lines (fits on one screen)
      - Single responsibility principle
      - Extract helper functions
      - Easier to test and verify
    patterns:
      - "(?:function|def)\\s+\\w+\\([^)]{400,}\\)"
      - "(?:function|def|const|let)\\s+\\w+.*\\([^)]{200,}\\)"
    max_function_lines: 60

  - id: NASA-005
    name: low_assertion_density
    category: assertions
    severity: medium
    description: "Use assertions at a density of at least 2 per function"
    guidance: |
      Assertions catch bugs early:
      - Minimum 2 assertions per function
      - Assert preconditions
      - Assert postconditions
      - Assert loop invariants
    patterns:
      - "(?:function|def)\\s+\\w+\\([^)]{400,}\\)"
      - "(?:function|def|const|let)\\s+\\w+.*\\([^)]{200,}\\)"
    min_assertions_per_function: 2

  - id: NASA-006
    name: minimal_scope
    category: scope
    severity: medium
    description: "Declare data objects at smallest possible scope"
    guidance: |
      Minimize variable scope:
      - Declare variables close to use
      - Avoid global variables
      - Prefer local over instance variables
      - Reduce cognitive load
    patterns:
      - "^global\\s+[a-z_]+"
      - "\\bglobalThis\\."
      - "\\bwindow\\.\\w+\\s*="
      - "^(?:var|let)\\s+\\w+\\s*=.*//.*global"

  - id: NASA-007
    name: check_return_values
    category: error_handling
    severity: high
    description: "Check return values of all non-void functions"
    guidance: |
      Never ignore return values:
      - Check all function returns
      - Handle error codes explicitly
      - Log unexpected returns
      - Use type hints to enforce
    patterns:
      - "^\\s+\\w+\\.(?:open|connect|acquire)\\s*\\([^)]*\\)\\s*$"

  - id: NASA-008
    name: limited_preprocessor
    category: preprocessor
    severity: medium
    description: "Limit preprocessor use to file inclusion and simple macros"
    guidance: |
      Preprocessor makes verification hard:
      - Use only for includes
      - Simple constant macros OK
      - No conditional compilation
      - No token pasting
    patterns:
      - "^\\s*#if(?!ndef)"
      - "^\\s*#elif"
      - "^\\s*##\\w+"

  - id: NASA-009
    name: limited_pointers
    category: pointers
    severity: high
    description: "Restrict pointer use to single dereference"
    guidance: |
      Pointers are error-prone:
      - No more than one level of dereferencing
      - No function pointers (unless unavoidable)
      - Prefer references to pointers
      - Validate all pointer operations
    patterns:
      - "->\\s*\\*\\*"
      - "\\*\\*\\*[a-z_]+"

  - id: NASA-010
    name: compile_clean
    category: compilation
    severity: high
    description: "Compile with all warnings enabled, treat warnings as errors"
    guidance: |
      Strict compiler settings:
      - Enable all warnings (-Wall -Wextra)
      - Treat warnings as errors (-Werror)
      - Use static analyzers
      - Zero tolerance for warnings
    compiler_flags:
      - "-Wall"
      - "-Wextra"
      - "-Werror"
      - "-pedantic"

