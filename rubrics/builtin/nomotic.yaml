# Nomotic Unified Rubric
# Complete Nomotic philosophy and AI governance rules
#
# Based on Nomotic AI principles (Chris Hood)
# Implements OWASP Layer 6 (Intent-Based Privilege) for GuardSpine
#
# MECE Categories (Mutually Exclusive, Collectively Exhaustive):
# 1. DOCUMENTATION - Explicit rule documentation, self-describing data
# 2. OBSERVABILITY - No hidden state, observable side effects
# 3. DESIGN - Declarative configuration, intent over implementation
# 4. ARCHITECTURE - Module boundaries, contract enforcement
# 5. TRACEABILITY - Decision tracing, audit trails
# 6. ERRORS - Explicit error handling
# 7. AUTHORITY - Approval authority basis
# 8. INTERRUPTS - Stop-the-line events
# 9. GOVERNANCE - Rule/policy change management
# 10. AI_ACCOUNTABILITY - AI model identification
#
# Core Nomotic Principles:
# - Explicit documentation of rules (nomos = law/rule)
# - Observable behavior over hidden state
# - Declarative intent over procedural implementation
# - Boundary clarity and contract enforcement
# - Traceable decision-making
# - Self-documenting systems

name: nomotic
version: "2.0"
description: "Unified Nomotic philosophy and AI governance rules (Chris Hood)"
partner: "Nomotic AI (Chris Hood)"

# =============================================================================
# BUNDLE EXTENSIONS (for evidence bundles)
# =============================================================================

bundle_extensions:
  - name: authority_basis
    type: object
    description: "Who has the right to approve and why"
    required: true
    schema:
      approver_id: string
      approver_role: string
      authority_source: string  # CODEOWNERS, policy, delegation
      delegation_chain: array
      constraints: array

  - name: constraints_applied
    type: array
    description: "What rules fired during evaluation"
    required: true
    item_schema:
      constraint_id: string
      constraint_name: string
      constraint_source: string
      triggered: boolean
      result: string  # pass, fail, warning
      details: string

  - name: interrupts_triggered
    type: array
    description: "What stop-the-line events occurred"
    required: false
    item_schema:
      interrupt_id: string
      interrupt_type: string  # mandatory_review, escalation, block
      trigger_condition: string
      triggered_at: timestamp
      resolved: boolean
      resolved_by: string
      resolution_note: string

# =============================================================================
# RULES (MECE Organized)
# =============================================================================

rules:
  # ---------------------------------------------------------------------------
  # CATEGORY 1: DOCUMENTATION
  # Rules about explicit documentation of business logic and data structures
  # ---------------------------------------------------------------------------

  - id: NOM-DOC-001
    name: explicit_rule_documentation
    category: documentation
    severity: medium
    description: "Business rules must be explicitly documented, not hidden in implementation"
    patterns:
      - "if\\s+[a-z_]+\\s*[><=!]+\\s*\\d+\\s*:"
      - "if\\s*\\(\\s*\\w+\\s*[><=!]+\\s*\\d+\\s*\\)"
    guidance: |
      Document thresholds and business rules explicitly:
      - Use constants with descriptive names
      - Add docstrings explaining the "why"
      - Consider a rules engine for complex logic
    exceptions:
      - "*_test.py"
      - "test_*.py"

  - id: NOM-DOC-002
    name: self_describing_data
    category: documentation
    severity: medium
    description: "Data structures should be self-describing"
    patterns:
      - "dict\\(\\)"
      - "data\\s*=\\s*\\{\\}"
      - "result\\s*=\\s*\\{\\}"
      - "(?:const|let|var)\\s+\\w+\\s*:\\s*any\\s*="
      - "(?:const|let|var)\\s+\\w+\\s*=\\s*\\{\\}"
    guidance: |
      Prefer typed structures over generic dicts:
      - Use dataclasses or Pydantic models
      - Define schemas for external data
      - Document expected keys and types

  # ---------------------------------------------------------------------------
  # CATEGORY 2: OBSERVABILITY
  # Rules about making system behavior visible and explicit
  # ---------------------------------------------------------------------------

  - id: NOM-OBS-001
    name: no_hidden_state
    category: observability
    severity: high
    description: "Avoid hidden state that affects behavior without explicit declaration"
    patterns:
      - "global\\s+[a-z_]+"
      - "_[a-z_]+\\s*=\\s*\\{\\}"
      - "_cache\\s*=\\s*\\{\\}"
      - "\\bglobalThis\\."
      - "\\bwindow\\.\\w+\\s*="
      - "(?:let|var)\\s+_\\w+\\s*=\\s*\\{\\}"
    guidance: |
      State should be:
      - Explicitly passed as parameters
      - Clearly documented in class/module docstrings
      - Observable via inspection methods
    exceptions:
      - "*.py:__init__"

  - id: NOM-OBS-002
    name: observable_side_effects
    category: observability
    severity: medium
    description: "Side effects must be explicitly declared and documented"
    patterns:
      - "def\\s+[a-z_]+\\([^)]*\\)\\s*:"
      - "(?:export\\s+)?(?:async\\s+)?function\\s+[a-z]\\w+\\("
    guidance: |
      Functions with side effects should:
      - Have names that indicate mutation (set_, update_, write_)
      - Document side effects in docstrings
      - Return indicators of what changed

  # ---------------------------------------------------------------------------
  # CATEGORY 3: DESIGN
  # Rules about declarative and intent-focused design
  # ---------------------------------------------------------------------------

  - id: NOM-DES-001
    name: declarative_configuration
    category: design
    severity: medium
    description: "Prefer declarative configuration over procedural setup"
    patterns:
      - "if.*env.*:.*setattr"
      - "for.*in.*config.*:.*if"
    guidance: |
      Configuration should be:
      - Declarative (YAML, JSON, dataclasses)
      - Validated at load time
      - Self-documenting with schemas

  - id: NOM-DES-002
    name: intent_over_implementation
    category: design
    severity: low
    description: "Function names should express intent, not implementation"
    patterns:
      - "def\\s+(loop_|iterate_|process_list_)"
      - "function\\s+(loop|iterate|processList)"
      - "(?:const|let)\\s+(loop|iterate|processList)\\w*\\s*="
    guidance: |
      Name functions by what they achieve:
      - calculate_total() not loop_and_sum()
      - validate_user() not check_fields()
      - send_notification() not call_api()

  # ---------------------------------------------------------------------------
  # CATEGORY 4: ARCHITECTURE
  # Rules about module boundaries and contracts
  # ---------------------------------------------------------------------------

  - id: NOM-ARCH-001
    name: clear_module_boundaries
    category: architecture
    severity: high
    description: "Modules must have clear boundaries with explicit contracts"
    patterns:
      - "from\\s+[a-z_]+\\.[a-z_]+\\.[a-z_]+\\.[a-z_]+\\s+import"
      - "from\\s+['\"][^'\"]+/[^'\"]+/[^'\"]+/[^'\"]+['\"]"
      - "require\\(['\"][^'\"]+/[^'\"]+/[^'\"]+/[^'\"]+['\"]\\)"
    guidance: |
      Deep imports indicate boundary violations:
      - Define public APIs at package level
      - Use __all__ to declare exports
      - Consider facade patterns

  - id: NOM-ARCH-002
    name: contract_enforcement
    category: architecture
    severity: high
    description: "Contracts between components must be explicit and enforced"
    patterns:
      - "def\\s+[a-z_]+\\([^:)]*\\)\\s*:"
      - "function\\s+\\w+\\([^)]*\\)\\s*[:{]"
      - "\\w+\\s*\\([^)]*\\)\\s*=>\\s*\\{"
    guidance: |
      Functions should enforce contracts:
      - Use type hints for all parameters
      - Validate inputs at boundaries
      - Use assertions for preconditions
      - Consider Protocol classes for interfaces

  # ---------------------------------------------------------------------------
  # CATEGORY 5: TRACEABILITY
  # Rules about decision tracing and audit trails
  # (Merged from philosophy NOM-002, NOM-011 and core NOM-CORE-004)
  # ---------------------------------------------------------------------------

  - id: NOM-TRACE-001
    name: traceable_decisions
    category: traceability
    severity: high
    description: "All decisions must be traceable with logged rationale"
    patterns:
      - "(?:def|function)\\s+\\w+.*(?:approve|reject|grant|deny|allow|block)"
      - "(?:^|\\s)(?:approve|reject|grant|deny|allow|block)\\s*\\([^)]*\\)\\s*[:{]"
    guidance: |
      Critical decision points should trace their reasoning:
      - Log the inputs, rule applied, and outcome
      - Use structured logging for audit trails
      - Consider event sourcing for important decisions
      - Log who, what, when, why
      - Be queryable for compliance
      - Support undo/rollback

  - id: NOM-TRACE-002
    name: decision_signatures
    category: traceability
    severity: high
    description: "All decisions must be traceable to a human or AI actor"
    validation:
      - field: scope.assertion_type
        not_empty: true
      - field: signatures
        min_length: 1
    guidance: |
      Every evidence bundle must have:
      - Clear assertion of what was decided
      - At least one signature (human or AI)
      - Timestamp of the decision
      - Link to the authority basis

  # ---------------------------------------------------------------------------
  # CATEGORY 6: ERRORS
  # Rules about explicit error handling
  # ---------------------------------------------------------------------------

  - id: NOM-ERR-001
    name: explicit_error_modes
    category: errors
    severity: high
    description: "Error modes must be explicit, not silent failures"
    patterns:
      - "except:\\s*pass"
      - "except\\s+Exception:\\s*pass"
      - "except.*:\\s*return\\s+None"
      - "catch\\s*\\([^)]*\\)\\s*\\{\\s*\\}"
      - "catch\\s*\\([^)]*\\)\\s*\\{\\s*return\\s+null"
    guidance: |
      Handle errors explicitly:
      - Catch specific exceptions
      - Log or re-raise, never swallow
      - Return typed error results (Result monad)

  # ---------------------------------------------------------------------------
  # CATEGORY 7: AUTHORITY
  # Rules about approval authority basis
  # ---------------------------------------------------------------------------

  - id: NOM-AUTH-001
    name: explicit_authority
    category: authority
    severity: critical
    description: "All approvals must cite authority basis"
    required_field: authority_basis
    validation:
      - field: authority_basis.authority_source
        not_empty: true
      - field: authority_basis.approver_role
        not_empty: true
    guidance: |
      Every approval decision must document:
      - Who approved (approver_id)
      - Their role (approver_role)
      - Source of their authority (CODEOWNERS, policy, delegation)
      - Any constraints on their authority

  # ---------------------------------------------------------------------------
  # CATEGORY 8: INTERRUPTS
  # Rules about stop-the-line events
  # ---------------------------------------------------------------------------

  - id: NOM-INT-001
    name: interrupt_rights
    category: interrupts
    severity: high
    description: "Certain conditions trigger mandatory human review"
    triggers:
      - condition: external_link_added
        interrupt_type: mandatory_review
        risk_tier_minimum: L3
        message: "External link detected - requires human review"

      - condition: signature_changed
        interrupt_type: mandatory_review
        risk_tier_minimum: L4
        message: "Signature block modified - requires authorized approver"

      - condition: financial_formula_changed
        interrupt_type: mandatory_review
        risk_tier_minimum: L3
        message: "Financial formula changed - requires finance authority"

      - condition: liability_clause_altered
        interrupt_type: escalation
        risk_tier_minimum: L4
        message: "Liability clause altered - requires general counsel review"

      - condition: pii_field_added
        interrupt_type: mandatory_review
        risk_tier_minimum: L3
        message: "PII field added - requires privacy review"

      - condition: auth_code_modified
        interrupt_type: mandatory_review
        risk_tier_minimum: L4
        message: "Authentication code modified - requires security review"

      - condition: api_key_pattern
        interrupt_type: block
        risk_tier_minimum: L4
        message: "Potential API key detected - blocked until removed"

  # ---------------------------------------------------------------------------
  # CATEGORY 9: GOVERNANCE
  # Rules about governance of rules/policies themselves
  # (Merged from philosophy NOM-012 and core NOM-CORE-003)
  # ---------------------------------------------------------------------------

  - id: NOM-GOV-001
    name: governed_adaptation
    category: governance
    severity: critical
    description: "Changes to rubrics/policies require multi-party approval and version control"
    artifact_patterns:
      - "rubrics/*.yaml"
      - "policies/*.yaml"
      - "*.rules.yaml"
    required_approvers:
      - role: policy_owner
        count: 1
      - role: security_reviewer
        count: 1
    risk_tier: L4
    creates_bundle: true
    changelog_required: true
    patterns:
      - "THRESHOLD\\s*=\\s*\\d+"
      - "LIMIT\\s*=\\s*\\d+"
      - "MAX_[A-Z_]+\\s*=\\s*\\d+"
    guidance: |
      Governance changes are themselves governed:
      1. PR to rubrics/ triggers L4 review
      2. Requires policy_owner + security_reviewer approval
      3. Creates evidence bundle for the governance change
      4. Must include changelog entry explaining the change

      Externalize business rules:
      - Store in configuration files
      - Version control separately
      - Support hot-reload where possible
      - Document change history

  # ---------------------------------------------------------------------------
  # CATEGORY 10: AI ACCOUNTABILITY
  # Rules about AI model identification and accountability
  # ---------------------------------------------------------------------------

  - id: NOM-AI-001
    name: ai_model_accountability
    category: ai_accountability
    severity: high
    description: "AI model decisions must include model identification"
    applies_to_signer_type: ai_model
    required_fields:
      - ai_model_id
      - ai_model_version
    guidance: |
      When an AI model makes or influences a decision:
      - Record the model identifier (e.g., claude-3-opus)
      - Record the specific version/checkpoint
      - This enables "which model, when" audit queries

# =============================================================================
# INTERRUPT RESOLUTION WORKFLOW
# =============================================================================

interrupt_resolution:
  mandatory_review:
    required_action: human_approval
    timeout_hours: 72
    escalation_on_timeout: true

  escalation:
    required_action: senior_approval
    timeout_hours: 24
    escalation_on_timeout: true
    notify_channels:
      - slack
      - email

  block:
    required_action: artifact_modification
    auto_resolve_on: condition_cleared
    notify_channels:
      - slack
      - email
      - github_pr

# =============================================================================
# AUTHORITY SOURCES
# =============================================================================

authority_sources:
  - id: codeowners
    name: "CODEOWNERS File"
    description: "GitHub CODEOWNERS automatic assignment"
    auto_detect: true

  - id: policy_delegation
    name: "Policy Delegation"
    description: "Authority delegated via policy configuration"
    requires_chain: true

  - id: role_based
    name: "Role-Based Authority"
    description: "Authority based on organizational role"
    requires_role_mapping: true

  - id: emergency_override
    name: "Emergency Override"
    description: "Break-glass authority for emergencies"
    requires_justification: true
    audit_level: critical
    expires_after_hours: 24

# =============================================================================
# MECE SUMMARY
# =============================================================================
#
# This unified rubric contains 15 rules organized into 10 MECE categories:
#
# | Category         | Rules | Coverage |
# |------------------|-------|----------|
# | DOCUMENTATION    | 2     | NOM-DOC-001, NOM-DOC-002 |
# | OBSERVABILITY    | 2     | NOM-OBS-001, NOM-OBS-002 |
# | DESIGN           | 2     | NOM-DES-001, NOM-DES-002 |
# | ARCHITECTURE     | 2     | NOM-ARCH-001, NOM-ARCH-002 |
# | TRACEABILITY     | 2     | NOM-TRACE-001, NOM-TRACE-002 |
# | ERRORS           | 1     | NOM-ERR-001 |
# | AUTHORITY        | 1     | NOM-AUTH-001 |
# | INTERRUPTS       | 1     | NOM-INT-001 |
# | GOVERNANCE       | 1     | NOM-GOV-001 |
# | AI_ACCOUNTABILITY| 1     | NOM-AI-001 |
#
# Deduplications applied:
# - Merged NOM-002, NOM-011, NOM-CORE-004 -> NOM-TRACE-001, NOM-TRACE-002
# - Merged NOM-012, NOM-CORE-003 -> NOM-GOV-001
